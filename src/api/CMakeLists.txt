#------------------------------------------------------------------------------
# Include source and build directories
#------------------------------------------------------------------------------
include_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/utils
  ${CMAKE_CURRENT_BINARY_DIR}
)

#------------------------------------------------------------------------------
# External dependencies
#------------------------------------------------------------------------------
# Mercury
find_package(MERCURY REQUIRED)
if(MERCURY_FOUND)
  message(STATUS "mercury include directory: ${MERCURY_INCLUDE_DIR}")
  set(PDC_EXT_INCLUDE_DEPENDENCIES ${MERCURY_INCLUDE_DIR}
    ${PDC_EXT_INCLUDE_DEPENDENCIES}
    )
  set(PDC_EXT_LIB_DEPENDENCIES mercury ${PDC_EXT_LIB_DEPENDENCIES})
endif()

include_directories(${PDC_EXT_INCLUDE_DEPENDENCIES})
#include_directories(${CMAKE_INSTALL_PREFIX}/skiplist/include/)

#------------------------------------------------------------------------------
# Configure module header files
#------------------------------------------------------------------------------
# Set unique vars used in the autogenerated config file (symbol import/export)
if(BUILD_SHARED_LIBS)
  set(PDC_BUILD_SHARED_LIBS 1)
  set(PDC_LIBTYPE SHARED)
else()
  set(PDC_BUILD_SHARED_LIBS 0)
  set(PDC_LIBTYPE STATIC)
endif()

configure_file(
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_config.h.in
  ${CMAKE_CURRENT_BINARY_DIR}/pdc_config.h
)

#------------------------------------------------------------------------------
# Set sources
#------------------------------------------------------------------------------
set(PDC_SRCS
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_interface.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_error.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_malloc.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_prop.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_cont.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_obj.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_dt_conv.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_client_connect.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_client_server_common.c
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_dart.c
  )

set(PDC_UTILS_SRC
    ${CMAKE_CURRENT_SOURCE_DIR}/utils/string_utils.c
    ${CMAKE_CURRENT_SOURCE_DIR}/utils/query_utils.c
    ${CMAKE_CURRENT_SOURCE_DIR}/utils/timer_utils.c
    ${CMAKE_CURRENT_SOURCE_DIR}/utils/hashset.c
    ${CMAKE_CURRENT_SOURCE_DIR}/utils/vector.c
    ${CMAKE_CURRENT_SOURCE_DIR}/utils/art.c
    )

#  add_subdirectory(${CMAKE_CURRENT_SOURCE_DIR}/server)

#------------------------------------------------------------------------------
# Libraries
#------------------------------------------------------------------------------
# PDC_UTILS
add_library(pdc_utils ${PDC_UTILS_SRC})
pdc_set_lib_options(pdc_utils "pdc_utils" ${PDC_LIBTYPE})

# PDC
add_library(pdc ${PDC_SRCS})
target_link_libraries(pdc pdc_utils ${PDC_EXPORTED_LIBS} ${PDC_EXT_LIB_DEPENDENCIES})
pdc_set_lib_options(pdc "pdc" ${PDC_LIBTYPE})

set(PDC_EXPORTED_LIBS pdc pdc_utils ${PDC_EXPORTED_LIBS})

#-----------------------------------------------------------------------------
# Specify project header files to be installed
#-----------------------------------------------------------------------------
set(PDC_HEADERS
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_private.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_error.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_interface.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_malloc.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_id_pkg.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_linkedlist.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_prop.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_prop_pkg.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_cont.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_cont_pkg.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_obj.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_obj_pkg.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_dt_conv.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_client_connect.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_client_server_common.h
  ${CMAKE_CURRENT_SOURCE_DIR}/pdc_dart.h
  )
set(PDC_UTILS_HEADERS
  ${CMAKE_CURRENT_SOURCE_DIR}/utils/string_utils.h
  ${CMAKE_CURRENT_SOURCE_DIR}/utils/query_utils.h
  ${CMAKE_CURRENT_SOURCE_DIR}/utils/timer_utils.h
  ${CMAKE_CURRENT_SOURCE_DIR}/utils/vector.h
  ${CMAKE_CURRENT_SOURCE_DIR}/utils/hashset.h
  ${CMAKE_CURRENT_SOURCE_DIR}/utils/art.h
)
#-----------------------------------------------------------------------------
# Add file(s) to CMake Install
#-----------------------------------------------------------------------------

install(
  FILES
    ${PDC_UTILS_HEADERS}
  DESTINATION
    ${PDC_INSTALL_INCLUDE_DIR}
  COMPONENT
    headers
)

install(
  FILES
    ${PDC_HEADERS}
  DESTINATION
    ${PDC_INSTALL_INCLUDE_DIR}
  COMPONENT
    headers
)

install(
  FILES
    ${PDC_HL_HEADERS}
  DESTINATION
    ${PDC_INSTALL_INCLUDE_DIR}
  COMPONENT
    headers
)

#-----------------------------------------------------------------------------
# Add Target(s) to CMake Install
#-----------------------------------------------------------------------------

install(
  TARGETS
    pdc_utils
  EXPORT
    ${PDC_EXPORTED_TARGETS}
  LIBRARY DESTINATION ${PDC_INSTALL_LIB_DIR}
  ARCHIVE DESTINATION ${PDC_INSTALL_LIB_DIR}
  RUNTIME DESTINATION ${PDC_INSTALL_BIN_DIR}
)

install(
  TARGETS
    pdc
  EXPORT
    ${PDC_EXPORTED_TARGETS}
  LIBRARY DESTINATION ${PDC_INSTALL_LIB_DIR}
  ARCHIVE DESTINATION ${PDC_INSTALL_LIB_DIR}
  RUNTIME DESTINATION ${PDC_INSTALL_BIN_DIR}
)

#-----------------------------------------------------------------------------
# Add Target(s) to CMake Install for import into other projects
#-----------------------------------------------------------------------------
install(
  EXPORT
    ${PDC_EXPORTED_TARGETS}
  DESTINATION
    ${PDC_INSTALL_DATA_DIR}/cmake/pdc
  FILE
    ${PDC_EXPORTED_TARGETS}.cmake
)

#-----------------------------------------------------------------------------
# Export all exported targets to the build tree for use by parent project
#-----------------------------------------------------------------------------
if(NOT PDC_EXTERNALLY_CONFIGURED)
EXPORT (
  TARGETS
    ${PDC_EXPORTED_LIBS}
  FILE
    ${PDC_EXPORTED_TARGETS}.cmake
)
endif()

#------------------------------------------------------------------------------
# Set variables for parent scope
#------------------------------------------------------------------------------
# Used by config.cmake.build.in and Testing
set(PDC_INCLUDES_BUILD_TIME
  ${CMAKE_CURRENT_SOURCE_DIR}
  ${CMAKE_CURRENT_SOURCE_DIR}/utils
  ${CMAKE_CURRENT_BINARY_DIR}
  ${PDC_EXT_INCLUDE_DEPENDENCIES}
  PARENT_SCOPE
)

# Used by config.cmake.install.in
set(PDC_INCLUDES_INSTALL_TIME
  ${PDC_INSTALL_INCLUDE_DIR}
  ${PDC_EXT_INCLUDE_DEPENDENCIES}
  PARENT_SCOPE
)
